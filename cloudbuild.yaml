steps:
  - id: 'Build Image'
    name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA', '.']

  - id: 'Tagging Image'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "develop" ]]; then
          echo "Tagging \"staging\" image"
          docker tag gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:staging
          echo "staging" > _TAG
        fi;

        if [[ "$TAG_NAME" ]]; then
          echo "Tagging image with $TAG_NAME"
          docker tag gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:latest
          docker tag gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:$TAG_NAME
          echo "$TAG_NAME" > _TAG
        fi;

        echo "Created tag name: $(cat _TAG)"

  - id: 'Push Image to Container Registry'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        TAG=$(cat _TAG)
        COUNT=0
        IMAGE_NAME="gcr.io/$PROJECT_ID/vuttr-frontend"

        echo "Images with tag $$TAG will be uploaded"
        docker images

        if [[ $(docker images -q $$IMAGE_NAME:latest) ]]; then
          echo "Deploying \"latest\" image"
          docker push $$IMAGE_NAME:latest
          COUNT=$$COUNT+1
        fi;

        if [[ $(docker images -q $$IMAGE_NAME:$$TAG) ]]; then
          echo "Deploying \"$$TAG\" image"
          docker push $$IMAGE_NAME:$$TAG
          COUNT=$$COUNT+1
        fi;

        if [[ $$COUNT == 0 ]]; then
          echo "No images have been uploaded to the registry"
          exit 1
        fi;

  - id: 'Deploy to Cloud Run'
    name: 'gcr.io/cloud-builders/gcloud'
    args:
      [
        'beta',
        'run',
        'deploy',
        '${_CLOUD_RUN_SERVICE_NAME}',
        '--image',
        'gcr.io/$PROJECT_ID/vuttr-frontend:$(cat _TAG)',
        '--platform',
        'managed',
        '--region',
        '${_CLOUD_RUN_SERVICE_REGION}',
        '--quiet',
      ]

images:
  - gcr.io/$PROJECT_ID/vuttr-frontend
