steps:
  - id: 'Build Image'
    name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA', '.']

  - id: 'Tagging Image'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ "$BRANCH_NAME" == "develop" ]]; then
          echo "Tagging \"staging\" image"
          docker gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:staging
          echo "staging" > _TAG
        fi;

        if [[ "$TAG_NAME" != "" ]]; then
          echo "Tagging image with $TAG_NAME"
          docker gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:latest
          docker gcr.io/$PROJECT_ID/vuttr-frontend:$COMMIT_SHA gcr.io/$PROJECT_ID/vuttr-frontend:$TAG_NAME
          echo "$TAG_NAME" > _TAG
        fi;

        echo "Created tag name: $(cat _TAG)"

  - id: 'Push Image to Container Registry'
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [[ $(docker images -q --filter 'reference=*vuttr-frontend:latest') ]]; then
          docker push gcr.io/$PROJECT_ID/vuttr-frontend:latest
        fi;

        if [[ $(docker images -q --filter "reference=*vuttr-frontend:$(cat _TAG)") ]]; then
          docker push gcr.io/$PROJECT_ID/vuttr-frontend:$(cat _TAG)
        fi;

  - id: 'Deploy to Cloud Run'
    name: 'gcr.io/cloud-builders/gcloud'
    args:
      [
        'beta',
        'run',
        'deploy',
        '${_CLOUD_RUN_SERVICE_NAME}',
        '--image',
        'gcr.io/$PROJECT_ID/vuttr-frontend:$(cat _TAG)',
        '--platform',
        'managed',
        '--region',
        '${_CLOUD_RUN_SERVICE_REGION}',
        '--quiet',
      ]

images:
  - gcr.io/$PROJECT_ID/vuttr-frontend
